const e=window;function CodeJar(t,n,r={}){const o={tab:"\t",indentOn:/[({\[]$/,moveToNewLine:/^[)}\]]/,spellcheck:false,catchTab:true,preserveIdent:true,addClosing:true,history:true,window:e,...r};const s=o.window;const i=s.document;const a=[];const d=[];let l=-1;let c=false;let onUpdate=()=>{};let f;t.setAttribute("contenteditable","plaintext-only");t.setAttribute("spellcheck",o.spellcheck?"true":"false");t.style.outline="none";t.style.overflowWrap="break-word";t.style.overflowY="auto";t.style.whiteSpace="pre-wrap";const doHighlight=(e,t)=>{n(e,t)};let u=false;"plaintext-only"!==t.contentEditable&&(u=true);u&&t.setAttribute("contenteditable","true");const p=debounce((()=>{const e=save();doHighlight(t,e);restore(e)}),30);let g=false;const shouldRecord=e=>!isUndo(e)&&!isRedo(e)&&"Meta"!==e.key&&"Control"!==e.key&&"Alt"!==e.key&&!e.key.startsWith("Arrow");const h=debounce((e=>{if(shouldRecord(e)){recordHistory();g=false}}),300);const on=(e,n)=>{a.push([e,n]);t.addEventListener(e,n)};on("keydown",(e=>{if(!e.defaultPrevented){f=toString();o.preserveIdent?handleNewLine(e):legacyNewLineFix(e);o.catchTab&&handleTabCharacters(e);o.addClosing&&handleSelfClosingCharacters(e);if(o.history){handleUndoRedo(e);if(shouldRecord(e)&&!g){recordHistory();g=true}}u&&!isCopy(e)&&restore(save())}}));on("keyup",(e=>{if(!e.defaultPrevented&&!e.isComposing){f!==toString()&&p();h(e);onUpdate(toString())}}));on("focus",(e=>{c=true}));on("blur",(e=>{c=false}));on("paste",(e=>{recordHistory();handlePaste(e);recordHistory();onUpdate(toString())}));on("cut",(e=>{recordHistory();handleCut(e);recordHistory();onUpdate(toString())}));function save(){const e=getSelection();const n={start:0,end:0,dir:void 0};let{anchorNode:r,anchorOffset:o,focusNode:s,focusOffset:a}=e;if(!r||!s)throw"error1";if(r===t&&s===t){n.start=o>0&&t.textContent?t.textContent.length:0;n.end=a>0&&t.textContent?t.textContent.length:0;n.dir=a>=o?"->":"<-";return n}if(r.nodeType===Node.ELEMENT_NODE){const e=i.createTextNode("");r.insertBefore(e,r.childNodes[o]);r=e;o=0}if(s.nodeType===Node.ELEMENT_NODE){const e=i.createTextNode("");s.insertBefore(e,s.childNodes[a]);s=e;a=0}visit(t,(e=>{if(e===r&&e===s){n.start+=o;n.end+=a;n.dir=o<=a?"->":"<-";return"stop"}if(e===r){n.start+=o;if(n.dir)return"stop";n.dir="->"}else if(e===s){n.end+=a;if(n.dir)return"stop";n.dir="<-"}if(e.nodeType===Node.TEXT_NODE){"->"!=n.dir&&(n.start+=e.nodeValue.length);"<-"!=n.dir&&(n.end+=e.nodeValue.length)}}));t.normalize();return n}function restore(e){const n=getSelection();let r,o=0;let s,a=0;e.dir||(e.dir="->");e.start<0&&(e.start=0);e.end<0&&(e.end=0);if("<-"==e.dir){const{start:t,end:n}=e;e.start=n;e.end=t}let d=0;visit(t,(t=>{if(t.nodeType!==Node.TEXT_NODE)return;const n=(t.nodeValue||"").length;if(d+n>e.start){if(!r){r=t;o=e.start-d}if(d+n>e.end){s=t;a=e.end-d;return"stop"}}d+=n}));r||(r=t,o=t.childNodes.length);s||(s=t,a=t.childNodes.length);"<-"==e.dir&&([r,o,s,a]=[s,a,r,o]);{const e=uneditable(r);if(e){const t=i.createTextNode("");e.parentNode?.insertBefore(t,e);r=t;o=0}const t=uneditable(s);if(t){const e=i.createTextNode("");t.parentNode?.insertBefore(e,t);s=e;a=0}}n.setBaseAndExtent(r,o,s,a);t.normalize()}function uneditable(e){while(e&&e!==t){if(e.nodeType===Node.ELEMENT_NODE){const t=e;if("false"==t.getAttribute("contenteditable"))return t}e=e.parentNode}}function beforeCursor(){const e=getSelection();const n=e.getRangeAt(0);const r=i.createRange();r.selectNodeContents(t);r.setEnd(n.startContainer,n.startOffset);return r.toString()}function afterCursor(){const e=getSelection();const n=e.getRangeAt(0);const r=i.createRange();r.selectNodeContents(t);r.setStart(n.endContainer,n.endOffset);return r.toString()}function handleNewLine(e){if("Enter"===e.key){const t=beforeCursor();const n=afterCursor();let[r]=findPadding(t);let s=r;o.indentOn.test(t)&&(s+=o.tab);if(s.length>0){preventDefault(e);e.stopPropagation();insert("\n"+s)}else legacyNewLineFix(e);if(s!==r&&o.moveToNewLine.test(n)){const e=save();insert("\n"+r);restore(e)}}}function legacyNewLineFix(e){if(u&&"Enter"===e.key){preventDefault(e);e.stopPropagation();if(""==afterCursor()){insert("\n ");const e=save();e.start=--e.end;restore(e)}else insert("\n")}}function handleSelfClosingCharacters(e){const t="([{'\"";const n=")]}'\"";if(t.includes(e.key)){preventDefault(e);const r=save();const o=r.start==r.end?"":getSelection().toString();const s=e.key+o+n[t.indexOf(e.key)];insert(s);r.start++;r.end++;restore(r)}}function handleTabCharacters(e){if("Tab"===e.key){preventDefault(e);if(e.shiftKey){const e=beforeCursor();let[t,n]=findPadding(e);if(t.length>0){const e=save();const r=Math.min(o.tab.length,t.length);restore({start:n,end:n+r});i.execCommand("delete");e.start-=r;e.end-=r;restore(e)}}else insert(o.tab)}}function handleUndoRedo(e){if(isUndo(e)){preventDefault(e);l--;const n=d[l];if(n){t.innerHTML=n.html;restore(n.pos)}l<0&&(l=0)}if(isRedo(e)){preventDefault(e);l++;const n=d[l];if(n){t.innerHTML=n.html;restore(n.pos)}l>=d.length&&l--}}function recordHistory(){if(!c)return;const e=t.innerHTML;const n=save();const r=d[l];if(r&&r.html===e&&r.pos.start===n.start&&r.pos.end===n.end)return;l++;d[l]={html:e,pos:n};d.splice(l+1);const o=300;if(l>o){l=o;d.splice(0,1)}}function handlePaste(e){if(e.defaultPrevented)return;preventDefault(e);const n=e.originalEvent??e;const r=n.clipboardData.getData("text/plain").replace(/\r\n?/g,"\n");const o=save();insert(r);doHighlight(t);restore({start:Math.min(o.start,o.end)+r.length,end:Math.min(o.start,o.end)+r.length,dir:"<-"})}function handleCut(e){const n=save();const r=getSelection();const o=e.originalEvent??e;o.clipboardData.setData("text/plain",r.toString());i.execCommand("delete");doHighlight(t);restore({start:Math.min(n.start,n.end),end:Math.min(n.start,n.end),dir:"<-"});preventDefault(e)}function visit(e,t){const n=[];e.firstChild&&n.push(e.firstChild);let r=n.pop();while(r){if("stop"===t(r))break;r.nextSibling&&n.push(r.nextSibling);r.firstChild&&n.push(r.firstChild);r=n.pop()}}function isCtrl(e){return e.metaKey||e.ctrlKey}function isUndo(e){return isCtrl(e)&&!e.shiftKey&&"Z"===getKeyCode(e)}function isRedo(e){return isCtrl(e)&&e.shiftKey&&"Z"===getKeyCode(e)}function isCopy(e){return isCtrl(e)&&"C"===getKeyCode(e)}function getKeyCode(e){let t=e.key||e.keyCode||e.which;if(t)return("string"===typeof t?t:String.fromCharCode(t)).toUpperCase()}function insert(e){e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");i.execCommand("insertHTML",false,e)}function debounce(e,t){let n=0;return(...r)=>{clearTimeout(n);n=s.setTimeout((()=>e(...r)),t)}}function findPadding(e){let t=e.length-1;while(t>=0&&"\n"!==e[t])t--;t++;let n=t;while(n<e.length&&/[ \t]/.test(e[n]))n++;return[e.substring(t,n)||"",t,n]}function toString(){return t.textContent||""}function preventDefault(e){e.preventDefault()}function getSelection(){return t.parentNode?.nodeType==Node.DOCUMENT_FRAGMENT_NODE?t.parentNode.getSelection():s.getSelection()}return{updateOptions(e){Object.assign(o,e)},updateCode(e){t.textContent=e;doHighlight(t);onUpdate(e)},onUpdate(e){onUpdate=e},toString:toString,save:save,restore:restore,recordHistory:recordHistory,destroy(){for(let[e,n]of a)t.removeEventListener(e,n)}}}export{CodeJar};

